/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2020 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
define(["./when-4ca4e419","./Check-430b3551","./Math-c0afb7aa","./Cartesian2-0cd32dae","./defineProperties-24e785e9","./Transforms-1f147cce","./RuntimeError-443472b0","./WebGLConstants-2ddfa2f9","./ComponentDatatype-adb4702b","./AttributeCompression-424ccc06","./IntersectionTests-9618f995","./Plane-6d029ea4","./WebMercatorProjection-3d1fffe8","./createTaskProcessorWorker","./EllipsoidTangentPlane-6e29c6f6","./OrientedBoundingBox-963ed09f","./TerrainEncoding-338b7a37"],function(Ee,e,Te,Ce,t,ve,Me,i,n,a,r,o,Ne,s,xe,be,Se){"use strict";var Pe=Uint16Array.BYTES_PER_ELEMENT,we=Int32Array.BYTES_PER_ELEMENT,Be=Uint32Array.BYTES_PER_ELEMENT,ye=Float32Array.BYTES_PER_ELEMENT,Ae=Float64Array.BYTES_PER_ELEMENT;function Re(e,t,i){i=Ee.defaultValue(i,Te.CesiumMath);for(var n=e.length,a=0;a<n;++a)if(i.equalsEpsilon(e[a],t,Te.CesiumMath.EPSILON12))return a;return-1}var _e=new Ce.Cartographic,We=new Ce.Cartesian3,Fe=new Ce.Cartesian3,Oe=new Ce.Cartesian3,Ye=new ve.Matrix4;function ke(e,t,i,n,a,r,o,s,u,h){for(var c=o.length,d=0;d<c;++d){var g=o[d],l=g.cartographic,m=g.index,p=e.length,I=l.longitude,f=l.latitude,f=Te.CesiumMath.clamp(f,-Te.CesiumMath.PI_OVER_TWO,Te.CesiumMath.PI_OVER_TWO),l=l.height-r.skirtHeight;r.hMin=Math.min(r.hMin,l),Ce.Cartographic.fromRadians(I,f,l,_e),u&&(_e.longitude+=s),u?d===c-1?_e.latitude+=h:0===d&&(_e.latitude-=h):_e.latitude+=s;f=r.ellipsoid.cartographicToCartesian(_e);e.push(f),t.push(l),i.push(Ce.Cartesian2.clone(i[m])),0<n.length&&n.push(n[m]),ve.Matrix4.multiplyByPoint(r.toENU,f,We);l=r.minimum,f=r.maximum;Ce.Cartesian3.minimumByComponent(We,l,l),Ce.Cartesian3.maximumByComponent(We,f,f);f=r.lastBorderPoint;Ee.defined(f)&&(f=f.index,a.push(f,p-1,p,p,m,f)),r.lastBorderPoint=g}}return s(function(e,t){e.ellipsoid=Ce.Ellipsoid.clone(e.ellipsoid),e.rectangle=Ce.Rectangle.clone(e.rectangle);var i=function(e,t,i,n,a,r,o,s,u,h){var c,d,g,l,m;ce=Ee.defined(n)?(c=n.west,d=n.south,g=n.east,l=n.north,m=n.width,n.height):(c=Te.CesiumMath.toRadians(a.west),d=Te.CesiumMath.toRadians(a.south),g=Te.CesiumMath.toRadians(a.east),l=Te.CesiumMath.toRadians(a.north),m=Te.CesiumMath.toRadians(n.width),Te.CesiumMath.toRadians(n.height));var p,I,f=[d,l],E=[c,g],T=ve.Transforms.eastNorthUpToFixedFrame(t,i),C=ve.Matrix4.inverseTransformation(T,Ye);s&&(p=Ne.WebMercatorProjection.geodeticLatitudeToMercatorAngle(d),I=1/(Ne.WebMercatorProjection.geodeticLatitudeToMercatorAngle(l)-p));var v=new DataView(e),M=Number.POSITIVE_INFINITY,N=Number.NEGATIVE_INFINITY,x=Fe;x.x=Number.POSITIVE_INFINITY,x.y=Number.POSITIVE_INFINITY,x.z=Number.POSITIVE_INFINITY;var b=Oe;b.x=Number.NEGATIVE_INFINITY,b.y=Number.NEGATIVE_INFINITY,b.z=Number.NEGATIVE_INFINITY;var S,P,w=0,B=0,y=0;for(P=0;P<4;++P){var A=w;S=v.getUint32(A,!0),A+=Be;var R=Te.CesiumMath.toRadians(180*v.getFloat64(A,!0));A+=Ae,-1===Re(E,R)&&E.push(R);R=Te.CesiumMath.toRadians(180*v.getFloat64(A,!0));A+=Ae,-1===Re(f,R)&&f.push(R),A+=2*Ae;R=v.getInt32(A,!0);A+=we,B+=R,R=v.getInt32(A,!0),y+=3*R,w+=S+Be}var _=[],W=[],F=new Array(B),O=new Array(B),Y=new Array(B),k=s?new Array(B):[],U=new Array(y),V=[],H=[],L=[],D=[],G=0,j=0;for(P=w=0;P<4;++P){S=v.getUint32(w,!0);var z=w+=Be,q=Te.CesiumMath.toRadians(180*v.getFloat64(w,!0));w+=Ae;var J=Te.CesiumMath.toRadians(180*v.getFloat64(w,!0));w+=Ae;var K=Te.CesiumMath.toRadians(180*v.getFloat64(w,!0)),Q=.5*K;w+=Ae;var X=Te.CesiumMath.toRadians(180*v.getFloat64(w,!0)),Z=.5*X;w+=Ae;var $=v.getInt32(w,!0);w+=we;var ee=v.getInt32(w,!0);w+=we,w+=we;for(var te=new Array($),ie=0;ie<$;++ie){var ne=q+v.getUint8(w++)*K;_e.longitude=ne;var ae=J+v.getUint8(w++)*X;_e.latitude=ae;var re=v.getFloat32(w,!0);if(w+=ye,0!==re&&re<h&&(re*=-Math.pow(2,u)),re*=6371010*r,_e.height=re,-1!==Re(E,ne)||-1!==Re(f,ae)){var oe=Re(_,_e,Ce.Cartographic);if(-1!==oe){te[ie]=W[oe];continue}_.push(Ce.Cartographic.clone(_e)),W.push(G)}te[ie]=G,Math.abs(ne-c)<Q?V.push({index:G,cartographic:Ce.Cartographic.clone(_e)}):Math.abs(ne-g)<Q?L.push({index:G,cartographic:Ce.Cartographic.clone(_e)}):Math.abs(ae-d)<Z?H.push({index:G,cartographic:Ce.Cartographic.clone(_e)}):Math.abs(ae-l)<Z&&D.push({index:G,cartographic:Ce.Cartographic.clone(_e)}),M=Math.min(re,M),N=Math.max(re,N),Y[G]=re;re=i.cartographicToCartesian(_e);F[G]=re,s&&(k[G]=(Ne.WebMercatorProjection.geodeticLatitudeToMercatorAngle(ae)-p)*I),ve.Matrix4.multiplyByPoint(C,re,We),Ce.Cartesian3.minimumByComponent(We,x,x),Ce.Cartesian3.maximumByComponent(We,b,b);ne=(ne-c)/(g-c);ne=Te.CesiumMath.clamp(ne,0,1);ae=(ae-d)/(l-d);ae=Te.CesiumMath.clamp(ae,0,1),O[G]=new Ce.Cartesian2(ne,ae),++G}for(var se=3*ee,ue=0;ue<se;++ue,++j)U[j]=te[v.getUint16(w,!0)],w+=Pe;if(S!==w-z)throw new Me.RuntimeError("Invalid terrain tile.")}F.length=G,O.length=G,Y.length=G,s&&(k.length=G);var he=G,a=j,e={hMin:M,lastBorderPoint:void 0,skirtHeight:o,toENU:C,ellipsoid:i,minimum:x,maximum:b};V.sort(function(e,t){return t.cartographic.latitude-e.cartographic.latitude}),H.sort(function(e,t){return e.cartographic.longitude-t.cartographic.longitude}),L.sort(function(e,t){return e.cartographic.latitude-t.cartographic.latitude}),D.sort(function(e,t){return t.cartographic.longitude-e.cartographic.longitude});o=1e-5;{var ce;ke(F,Y,O,k,U,e,V,-o*m,!0,-o*ce),ke(F,Y,O,k,U,e,H,-o*ce,!1),ke(F,Y,O,k,U,e,L,o*m,!0,o*ce),ke(F,Y,O,k,U,e,D,o*ce,!1),0<V.length&&0<D.length&&(ge=V[0].index,le=D[D.length-1].index,ce=F.length-1,U.push(le,ce,he,he,ge,le))}B=F.length;var de,ge=ve.BoundingSphere.fromPoints(F);Ee.defined(n)&&(de=be.OrientedBoundingBox.fromRectangle(n,M,N,i));for(var le=new Se.EllipsoidalOccluder(i).computeHorizonCullingPointPossiblyUnderEllipsoid(t,F,M),n=new xe.AxisAlignedBoundingBox(x,b,t),me=new Se.TerrainEncoding(n,e.hMin,N,T,!1,s),pe=new Float32Array(B*me.getStride()),Ie=0,fe=0;fe<B;++fe)Ie=me.encode(pe,Ie,F[fe],O[fe],Y[fe],void 0,k[fe]);t=V.map(function(e){return e.index}).reverse(),n=H.map(function(e){return e.index}).reverse(),e=L.map(function(e){return e.index}).reverse(),T=D.map(function(e){return e.index}).reverse();return n.unshift(e[e.length-1]),n.push(t[0]),T.unshift(t[t.length-1]),T.push(e[0]),{vertices:pe,indices:new Uint16Array(U),maximumHeight:N,minimumHeight:M,encoding:me,boundingSphere3D:ge,orientedBoundingBox:de,occludeePointInScaledSpace:le,vertexCountWithoutSkirts:he,indexCountWithoutSkirts:a,westIndicesSouthToNorth:t,southIndicesEastToWest:n,eastIndicesNorthToSouth:e,northIndicesWestToEast:T}}(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold),n=i.vertices;return t.push(n.buffer),e=i.indices,t.push(e.buffer),{vertices:n.buffer,indices:e.buffer,numberOfAttributes:i.encoding.getStride(),minimumHeight:i.minimumHeight,maximumHeight:i.maximumHeight,boundingSphere3D:i.boundingSphere3D,orientedBoundingBox:i.orientedBoundingBox,occludeePointInScaledSpace:i.occludeePointInScaledSpace,encoding:i.encoding,vertexCountWithoutSkirts:i.vertexCountWithoutSkirts,indexCountWithoutSkirts:i.indexCountWithoutSkirts,westIndicesSouthToNorth:i.westIndicesSouthToNorth,southIndicesEastToWest:i.southIndicesEastToWest,eastIndicesNorthToSouth:i.eastIndicesNorthToSouth,northIndicesWestToEast:i.northIndicesWestToEast}})});
