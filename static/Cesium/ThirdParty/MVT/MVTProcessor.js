/**
 * Cesium - https://github.com/AnalyticalGraphicsInc/cesium
 *
 * Copyright 2011-2020 Cesium Contributors
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * Columbus View (Pat. Pend.)
 *
 * Portions licensed separately.
 * See https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md for full licensing details.
 */
function MVTProcessor(){this.styles=null,this.scale=.125,this.bounds=[],this.tileBound={left:0,top:0,right:4096,bottom:4096},this.request=new MVTRequest,this.colorParser=new MVTColorParser,this.filter=new MVTFilter,this.function=new MVTFunction,this.tileSize=512,this.offscreen=new OffscreenCanvas(this.tileSize,this.tileSize),this.styleLoaded=!1}MVTProcessor.prototype={process:function(t){"SetStyles"==t.fun?(this.setStyles(t),this.styleLoaded=!0):"LoadTile"==t.fun&&this.styleLoaded&&this.loadVectorTile(t)},setStyles:function(t){this.styles=t.styles},getRefLayer:function(t){var e=this.styles.layers;if(null!=e)for(var l=0;l<e.length;l++)if(e[l].id==t)return e[l];return null},loadVectorTile:function(t){var e=this.offscreen.getContext("2d");e.save(),e.scale(this.scale,this.scale);for(var l=e.getImageData(0,0,this.tileSize,this.tileSize),i=l.data,o=0;o<i.length;o+=4)i[o+3]=0;e.putImageData(l,0,0);var n=this.styles.layers;if(null!=n){for(var s,r={},o=0;o<n.length;o++)null!=(a=n[o])&&"background"!=a.id&&this.isVisibleLayer(a,t)&&(null==(u=a.source)||""==u||u in r||(s=this.request.getSourceURL(u,this.styles.sources,t),null!=(s=this.request.getTileData(s,"arraybuffer"))&&""!=s&&(r[u]=new MVTData(new Pbf(s)))));for(var a,u,h,f,c,y,g,d,o=0;o<n.length;o++)null!=(a=n[o])&&("road_trunk_primary_casing"==a.id&&0,"background"==a.id?this.drawBackgroundLayer(t,e,a.paint):this.isVisibleLayer(a,t)&&(d=u="",(h=null)!=a.ref?null!=(h=this.getRefLayer(a.ref))&&(u=h.source,d=h["source-layer"]):(u=a.source,d=a["source-layer"]),u in r&&(null==(g=r[u])||null!=(f=g.layers[d])&&(c=a.type,y=a.filter,g=a.layout,d=a.paint,null!=h&&(c=h.type,y=h.filter,g=h.layout),"road_trunk_primary_casing"==a.id&&0,this.drawSourceLayer(t,e,f,c,y,g,d)))))}this.bounds=[],e.restore();var m=e.getImageData(0,0,this.tileSize,this.tileSize),l=[];l.push(m.data.buffer),postMessage({result:t,buffer:l},l)},drawBackgroundLayer:function(t,e,l){var i="#0000ff";null!=l&&(i=this.colorParser.parse(this.function.getValue(l["background-color"],t.z)));t=t.w/this.scale;e.fillStyle=i,e.fillRect(0,0,t,t)},drawSourceLayer:function(t,e,l,i,o,n,s){for(var r=0;r<l.length;r++){var a=l.feature(r);console.log(a),null!=a&&this.filter.filterExpression(o,a)&&("fill"==i?this.drawFill(t,e,n,s,a):"line"==i?this.drawLine(t,e,n,s,a):"symbol"==i&&this.drawSymbol(t,e,n,s,a))}},drawFill:function(t,e,l,i,o){if(null!=i){var n=this.colorParser.parse(this.function.getValue(i["fill-color"],t.z));e.fillStyle=n;t=this.function.getValue(i["fill-opacity"],t.z);null!=t&&(e.globalAlpha=t);for(var s=classifyRings(o.loadGeometry()),r=0;r<s.length;r++)for(var a=s[r],u=0;u<a.length;u++){e.beginPath();for(var h=a[u],f=0;f<h.length;f++)0==f?e.moveTo(h[f].x,h[f].y):e.lineTo(h[f].x,h[f].y);e.closePath(),e.fill()}null!=t&&(e.globalAlpha=1)}},drawLine:function(t,e,l,i,o){if(null!=i){var n=this.function.getValue(i["line-width"],t.z);null==n&&(n=1),e.lineWidth=n/this.scale,e.strokeStyle=this.colorParser.parse(this.function.getValue(i["line-color"],t.z));t=this.function.getValue(i["line-opacity"],t.z);null!=t&&(e.globalAlpha=t);for(var s=o.loadGeometry(),r=0;r<s.length;r++){e.beginPath();for(var a=s[r],u=0;u<a.length;u++)0==u?e.moveTo(a[u].x,a[u].y):e.lineTo(a[u].x,a[u].y);e.stroke()}null!=t&&(e.globalAlpha=1)}},drawSymbol:function(t,e,l,i,o){},isVisibleLayer:function(t,e){return(null==t.layout||"none"!=t.layout.visibility)&&(null==t.minzoom&&null==t.maxzoom||!(null!=t.minzoom&&e.z<t.minzoom)&&(!(null!=t.maxzoom&&e.z>t.maxzoom)&&(null!=t.minzoom&&null!=t.maxzoom&&e.z>=t.minzoom&&e.z<=t.maxzoom||(null==t.minzoom||null==t.maxzoom))))},isIntersectBounds:function(t){if(!this.isContains(this.tileBound,t))return!0;for(var e=0;e<this.bounds.length;e++)if(this.isIntersect(this.bounds[e],t))return!0;return this.bounds.push(t),!1},isContains:function(t,e){return t.left<=e.left&&t.top<=e.top&&t.right>=e.right&&t.bottom>=e.bottom},isIntersect:function(t,e){return t.right>=e.left&&t.left<=e.right&&t.bottom>=e.top&&t.top<=e.bottom}};